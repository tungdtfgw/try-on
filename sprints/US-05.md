# US-05: Xem ảnh thử đồ khi chọn sản phẩm

## Bối cảnh
- Epic: Phòng thử đồ.
- Vai trò: Người mua (User đã đăng nhập và có avatar).
- Mục tiêu: Có thể xem trước hình ảnh bản thân mặc sản phẩm để quyết định mua hàng.

## Phạm vi
- Khi user chọn một danh mục, hệ thống hiển thị sản phẩm đầu tiên kèm ảnh try-on được tạo tự động.
- Ảnh try-on được sinh ra bằng cách kết hợp avatar của user với ảnh sản phẩm (flat lay) sử dụng Google Gemini AI.
- Ảnh try-on được lưu tạm trong profile user (tối đa 5 ảnh để tiết kiệm storage).
- Nếu đã có ảnh try-on được cache cho sản phẩm đó, hệ thống sử dụng lại thay vì sinh mới.
- User phải có avatar đã upload và thông tin body (height_cm, weight_kg) để sử dụng tính năng này.

## Luồng chính (happy path)
- **Truy cập phòng thử đồ:** User vào trang "Thử đồ" → chọn 1 danh mục từ danh sách → hệ thống load sản phẩm đầu tiên trong danh mục.
- **Sinh ảnh try-on:** Hệ thống kiểm tra cache ảnh try-on → nếu không có → gọi API sinh ảnh với Google Gemini (input: avatar + product image) → lưu ảnh vào Supabase Storage → lưu record vào database (tryon_images) → hiển thị ảnh cho user.
- **Hiển thị kết quả:** Màn hình hiển thị ảnh try-on (user mặc sản phẩm), thông tin sản phẩm (tên, giá, danh mục, mô tả), và các nút điều hướng (prev/next).
- **Cache management:** Khi số ảnh try-on của user > 5, hệ thống tự động xóa ảnh cũ nhất (FIFO) để đảm bảo giới hạn storage.

## Luồng lỗi cần xử lý
- User chưa có avatar → hiển thị thông báo và link đến trang profile để upload.
- User chưa có thông tin body (height/weight) → hiển thị thông báo và link đến trang profile.
- Danh mục không có sản phẩm → hiển thị thông báo "Chưa có sản phẩm trong danh mục này".
- Sản phẩm không có ảnh → skip và chuyển sang sản phẩm tiếp theo hoặc thông báo.
- Google Gemini API lỗi → hiển thị thông báo thân thiện, cho phép retry.
- API rate limit/quota exceeded → hiển thị thông báo và suggest thử lại sau.
- Upload ảnh vào Storage thất bại → thông báo lỗi, không lưu record.
- Lỗi mạng/server → thông báo thân thiện, không lộ chi tiết kỹ thuật.

## Dữ liệu & validate gợi ý
- **tryon_images table:**
  - id: UUID, primary key.
  - profile_id: UUID, foreign key to profiles.
  - product_id: UUID, foreign key to products.
  - image_url: string, URL ảnh trong Supabase Storage.
  - created_at: timestamp.
- **Constraint:** mỗi profile chỉ có tối đa 5 records trong tryon_images.
- **Unique constraint:** (profile_id, product_id) để tránh duplicate.
- **Avatar requirement:** profiles.photo_url phải có giá trị.
- **Body info requirement:** profiles.height_cm và profiles.weight_kg phải có giá trị.

## Acceptance Criteria (kết hợp sprint backlog)
- User có thể chọn danh mục và xem ảnh try-on của sản phẩm đầu tiên.
- Ảnh try-on được sinh bằng Google Gemini AI kết hợp avatar và product image.
- Ảnh try-on được cache trong database và Storage (tối đa 5 ảnh/user).
- Nếu đã có ảnh try-on cached, hệ thống sử dụng lại (không gọi AI).
- Hiển thị loading state rõ ràng khi đang sinh ảnh.
- User không có avatar/body info sẽ được guide đến trang profile.
- Thông báo lỗi thân thiện khi có vấn đề với AI generation.
- UI/UX thân thiện, hiển thị ảnh try-on nổi bật, thông tin sản phẩm rõ ràng.
- Responsive trên mobile và desktop.

## Phi chức năng
- Endpoint yêu cầu JWT authentication (chỉ user đã login).
- Google Gemini API key được lưu trong .env (GEMINI_API_KEY).
- Ảnh try-on được lưu trong bucket riêng trên Supabase Storage (tryon-images).
- Storage bucket policy: private (chỉ owner có thể read), authenticated users có thể write.
- API response time cho cache hit < 500ms.
- API response time cho AI generation < 30s (do cần chờ Gemini xử lý).
- Hiển thị progress/loading indicator khi generation > 2s.
- Cân nhắc retry logic với exponential backoff khi Gemini lỗi.
