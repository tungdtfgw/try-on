# US-06: Điều hướng giữa các sản phẩm trong phòng thử đồ

## Bối cảnh
- Epic: Phòng thử đồ.
- Vai trò: Người mua (User đã đăng nhập và có avatar).
- Mục tiêu: Có thể duyệt qua nhiều sản phẩm trong danh mục để so sánh và tìm sản phẩm ưng ý.

## Phạm vi
- User có thể bấm nút Next/Prev (hoặc vuốt trên mobile) để chuyển sang sản phẩm khác trong cùng danh mục.
- Khi chuyển sản phẩm, hệ thống hiển thị ảnh try-on của sản phẩm mới (từ cache hoặc sinh mới).
- Hệ thống pre-generate ảnh try-on của sản phẩm tiếp theo trong background để tối ưu trải nghiệm.
- Danh sách sản phẩm có thể wrap around (sau sản phẩm cuối quay lại sản phẩm đầu).
- Hiển thị indicator vị trí hiện tại trong danh sách (vd: "3/15 sản phẩm").

## Luồng chính (happy path)
- **Điều hướng Next:** User bấm nút Next (→) → hệ thống load sản phẩm tiếp theo → kiểm tra cache ảnh try-on → nếu có: hiển thị ngay → nếu không: sinh ảnh mới → hiển thị ảnh try-on và thông tin sản phẩm mới.
- **Điều hướng Prev:** User bấm nút Prev (←) → tương tự như Next nhưng di chuyển về sản phẩm trước đó.
- **Pre-generation:** Khi user đang xem sản phẩm hiện tại → background process kiểm tra sản phẩm tiếp theo → nếu chưa có ảnh try-on trong cache → gọi API sinh ảnh và lưu cache → không block UI hiện tại.
- **Wrap around:** Ở sản phẩm cuối bấm Next → quay về sản phẩm đầu. Ở sản phẩm đầu bấm Prev → đến sản phẩm cuối.
- **Position indicator:** Hiển thị "Sản phẩm 3/15" để user biết vị trí trong danh sách.

## Luồng lỗi cần xử lý
- Danh mục chỉ có 1 sản phẩm → disable cả 2 nút Next/Prev hoặc không hiển thị.
- Pre-generation thất bại → silent fail, khi user navigate sẽ trigger generation lại.
- Cache đầy (>5 ảnh) khi pre-generate → xóa ảnh cũ nhất trước khi lưu mới.
- Sản phẩm tiếp theo không có ảnh → skip và chuyển sang sản phẩm kế tiếp.
- Network error khi navigate → hiển thị thông báo, cho phép retry.
- Generation đang chạy, user navigate tiếp → cancel request cũ, start request mới.
- Rate limit khi pre-generate → backoff và retry sau.

## Dữ liệu & validate gợi ý
- **Navigation state:**
  - category_id: UUID, danh mục đang xem.
  - product_index: number, index sản phẩm hiện tại (0-based).
  - products_count: number, tổng số sản phẩm trong danh mục.
- **Pre-generation queue:** Sử dụng state management (React state hoặc context) để track:
  - Sản phẩm đang được pre-generate.
  - Status của pre-generation (pending, loading, success, failed).
- **Request cancellation:** Sử dụng AbortController để cancel pending requests khi user navigate nhanh.

## Acceptance Criteria (kết hợp sprint backlog)
- User có thể bấm Next/Prev để chuyển sản phẩm.
- Ảnh try-on của sản phẩm mới được hiển thị (từ cache hoặc sinh mới).
- Pre-generation chạy background khi user đang xem sản phẩm hiện tại.
- Pre-generation không block UI và không gây lag.
- Position indicator hiển thị chính xác (vd: "2/10 sản phẩm").
- Wrap around hoạt động đúng (cuối → đầu, đầu → cuối).
- Loading state hiển thị khi đang sinh ảnh mới (không từ cache).
- Transition mượt mà giữa các sản phẩm (animation nhẹ).
- Swipe gesture hoạt động trên mobile (optional nhưng khuyến khích).
- UI/UX thân thiện, nút điều hướng dễ nhận biết và click.
- Responsive trên mobile và desktop.

## Phi chức năng
- Endpoint yêu cầu JWT authentication.
- Pre-generation chạy với priority thấp hơn request chính của user.
- Cancel mechanism để tránh waste resources khi user navigate nhanh.
- Debounce navigation để tránh spam clicks (300ms).
- Cache check phải nhanh (<100ms) để quyết định có cần generate không.
- Lazy load danh sách sản phẩm trong danh mục (chỉ load metadata, không load tất cả ảnh).
- Smooth animation transition (fade hoặc slide) khi chuyển sản phẩm.
- Keyboard navigation support (← →) cho desktop users.
- Touch swipe support cho mobile users.
