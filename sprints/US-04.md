# US-04: Quản lý sản phẩm

## Bối cảnh
- Epic: Quản lý kho hàng.
- Vai trò: Admin.
- Mục tiêu: Có đầy đủ sản phẩm với thông tin và hình ảnh để khách hàng có thể xem và thử đồ ảo.

## Phạm vi
- Admin có thể xem danh sách tất cả sản phẩm với thông tin cơ bản và hình ảnh.
- Admin có thể filter sản phẩm theo danh mục.
- Admin có thể tạo sản phẩm mới với tên, giá, danh mục, mô tả và upload ảnh sản phẩm (flat lay - trải phẳng).
- Admin có thể sửa thông tin sản phẩm và thay đổi ảnh.
- Admin có thể xóa sản phẩm.
- Người dùng thông thường (non-admin) có thể xem danh sách và chi tiết sản phẩm nhưng không được phép tạo/sửa/xóa.
- Hệ thống lưu trữ ảnh sản phẩm trên Supabase Storage.
- Danh sách sản phẩm có pagination để tối ưu hiển thị.

## Luồng chính (happy path)
- **Xem danh sách:** Admin truy cập trang quản lý sản phẩm → hệ thống hiển thị danh sách products dạng grid/table với ảnh thumbnail, tên, giá, danh mục → có pagination để navigate.
- **Filter:** Admin chọn 1 danh mục từ dropdown → danh sách được filter chỉ hiển thị sản phẩm thuộc danh mục đó.
- **Tạo mới:** Admin bấm "Thêm sản phẩm" → form hiển thị (tên, giá, danh mục, mô tả, upload ảnh) → Admin nhập đầy đủ và chọn ảnh → preview ảnh → submit → server validate → upload ảnh lên Storage → lưu product info vào database → thông báo thành công → danh sách được refresh.
- **Sửa:** Admin bấm "Sửa" trên 1 sản phẩm → form hiển thị thông tin hiện tại và ảnh → Admin chỉnh sửa (có thể thay ảnh mới) → submit → server validate → upload ảnh mới (nếu có) → cập nhật database → thông báo thành công → danh sách được refresh.
- **Xóa:** Admin bấm "Xóa" trên 1 sản phẩm → hiển thị confirmation dialog → Admin xác nhận → server xóa ảnh khỏi Storage → xóa product khỏi database → thông báo thành công → danh sách được refresh.

## Luồng lỗi cần xử lý
- Tên sản phẩm trống hoặc quá dài (>200 ký tự).
- Giá không hợp lệ (<=0 hoặc không phải số).
- Danh mục không được chọn hoặc không tồn tại.
- Ảnh không được upload hoặc format không hợp lệ (chỉ chấp nhận jpg, jpeg, png).
- Ảnh quá lớn (>5MB).
- Upload ảnh thất bại → rollback transaction, không lưu product.
- Non-admin cố gắng truy cập endpoint tạo/sửa/xóa → trả về 403 Forbidden.
- Lỗi mạng/server → thông báo thân thiện, không lộ chi tiết.
- Product không tồn tại khi sửa/xóa → trả về 404 Not Found.
- Xóa ảnh cũ thất bại khi update → log warning nhưng vẫn update product.

## Dữ liệu & validate gợi ý
- **name:** bắt buộc, string, 1-200 ký tự, trim whitespace.
- **price:** bắt buộc, number, >0, max 2 decimal places.
- **category_id:** bắt buộc, UUID, phải tồn tại trong bảng categories.
- **description:** optional, string, max 1000 ký tự.
- **image_url:** string, URL của ảnh trong Supabase Storage.
- **created_at, updated_at:** timestamp, tự động.
- **Image file:** jpg/jpeg/png, max 5MB, khuyến nghị tỷ lệ square hoặc portrait cho flat lay.

## Acceptance Criteria (kết hợp sprint backlog)
- Admin có thể xem danh sách tất cả products với pagination.
- Admin có thể filter products theo category.
- Admin có thể tạo product mới với đầy đủ thông tin và upload ảnh.
- Ảnh được lưu trữ trên Supabase Storage và URL được lưu vào database.
- Admin có thể sửa product và thay đổi ảnh (xóa ảnh cũ, upload ảnh mới).
- Admin có thể xóa product (xóa cả ảnh khỏi Storage).
- Preview ảnh trước khi upload/submit.
- Non-admin không thể tạo/sửa/xóa products (trả về 403).
- Validation đầy đủ cho tất cả trường và file upload.
- Thông báo lỗi rõ ràng cho từng trường hợp.
- UI/UX thân thiện, hiển thị đẹp với ảnh sản phẩm, responsive.
- Pagination hoạt động chính xác với limit/offset.

## Phi chức năng
- Endpoint public (GET /api/products, GET /api/products/:id) không yêu cầu authentication.
- Endpoint admin (POST, PUT, DELETE) yêu cầu JWT và role=admin.
- Ảnh được lưu trong bucket riêng trên Supabase Storage với policy phù hợp (public read, admin write).
- Database indexes trên category_id để tối ưu filter query.
- Thông báo lỗi/success nhất quán.
- UI hoạt động tốt trên desktop và mobile.
- API response time < 1s cho operations thông thường (bao gồm upload).
- Cân nhắc resize/compress ảnh trước khi upload để tối ưu storage (optional cho sprint 2, có thể làm sau).
